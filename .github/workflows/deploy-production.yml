name: Deploy to Production

on:
  release:
    types:
      - published

jobs:
  deploy:
    # Do not deploy in the main repository, only in user projects
    if: github.repository_owner != 'fastapi'
    runs-on:
      - self-hosted
      - production
    env:
      ENVIRONMENT: production
      DOMAIN: ${{ secrets.DOMAIN_PRODUCTION }}
      STACK_NAME: ${{ secrets.STACK_NAME_PRODUCTION }}
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      FIRST_SUPERUSER: ${{ secrets.FIRST_SUPERUSER }}
      FIRST_SUPERUSER_PASSWORD: ${{ secrets.FIRST_SUPERUSER_PASSWORD }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
      EMAILS_FROM_EMAIL: ${{ secrets.EMAILS_FROM_EMAIL }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Build images
        run: docker compose -f docker-compose.yml --project-name ${{ secrets.STACK_NAME_PRODUCTION }} build

      - name: Deploy (migrations + services)
        run: docker compose -f docker-compose.yml --project-name ${{ secrets.STACK_NAME_PRODUCTION }} up -d

      - name: Wait for backend health check
        run: |
          echo "Waiting for backend to become healthy..."
          CONTAINER=$(docker compose -f docker-compose.yml --project-name ${{ secrets.STACK_NAME_PRODUCTION }} ps -q backend)
          for i in $(seq 1 24); do
            HEALTH=$(docker inspect --format='{{.State.Health.Status}}' "$CONTAINER" 2>/dev/null || echo "starting")
            echo "  Attempt $i/24: $HEALTH"
            if [ "$HEALTH" = "healthy" ]; then
              echo "Backend is healthy!"
              exit 0
            fi
            sleep 5
          done
          echo "ERROR: Backend did not become healthy within 120s"
          echo "Run: ./scripts/rollback.sh to revert"
          docker compose -f docker-compose.yml --project-name ${{ secrets.STACK_NAME_PRODUCTION }} logs backend --tail=50
          exit 1

      - name: Verify migration state
        run: |
          docker compose -f docker-compose.yml --project-name ${{ secrets.STACK_NAME_PRODUCTION }} \
            exec -T backend alembic current 2>/dev/null | grep "(head)" || {
              echo "ERROR: Alembic is NOT at head after deploy!"
              echo "Run: ./scripts/rollback.sh --migrate -1 to revert"
              exit 1
            }
          echo "Migration verification passed."
